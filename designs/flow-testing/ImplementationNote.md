# Implementation Note on Flow Testing Prototype

## Summary

This document describes the internal implementation of the prototype of flow-testing plugin for Node-RED as of December 2021.

## Flow Testing Plugin

### Initialization

At the time of installation of the flow test plugin, the flow testing plugin registers the following:

**On Runtime:**

1. Event (`registry:plugin-added`) handler for monitoring plugin installation for test actions (see [below](#actions-extension)),

2. Internal API endpoint (`/flow-tester/executeAction/:action`) for accepting instructions to execute test actions from the Node-RED editor,

3. Internal API endpoint (`/flow-tester/testCase`) for getting information on currently defined test cases,

4. Internal API endpoint (`/flow-tester/runTestCase/:suite/:test`) for accepting instructions to execute individual test case.

**On Editor:**

1. Message (`flow-test:log`) handler for displaying log message on flow testing sidebar,

2. Message (`flow-test:notify`) handler for displaying log message on flow testing sidebar and showing notification message,

3. Message (`flow-test:maxActions`) handler for notifying that actions execution has reached its limit,

4. Message (`flow-test:clear-match-result`) handler for clearing expected number of checks,

5. Message (`flow-test:click`) handler for clicking button of specified node (e.g. Inject node),

6. Event (`registry:plugin-added`) handler for monitoring plugin installation for test actions (see [below](#actions-extension)),

7. Sidebar for flow testing,

8. Event (`nodes:added`, `nodes:remove`, and `nodes:change`) handler for monitoring addition/removal/change of flow test configuration (`flow-test-config` node),

9. Event (`nodes:dialog-prepare`, `nodes:dialog-resize`, and `editor:save`) handler for preparing/resizing flow test tab of node settings panel and storing flow test configuration for the node (see [below](#flow-test-plugin-support-in-node-red-editor)), 

### Executing Test Actions

  Execution of test case is performed in the following order on editor side:

1. Initialize test environment calling *init* action of runtime,
   
   - On editor side,
     
     - count number of checks in current test case,
       
       - this number is used for checking completion of the test case
   
   - On runtime side, 
     
     - clear current actions list,
     
     - register a message router hook (`onReceive.flow-test`) for handling node `receive` event and executing corresponding actions,
     
     - register a message router hook (`preRoute.flow-test`) for handling node `stub` event and executing corresponding actions,
     
     - register a message router hook (`onSend.flow-test`) for handling node `send` event and executing corresponding actions.

2. Register events and associated actions calling `registerActions` action of runtime,
   
   - On runtime side,
     
     - register events and associated actions information in current test in `actionMap` data.  It maps *event* → *node id* → *array of action information*.  The action information is a object consisting of action specific properties and following common properties:
       
       | name    | type   | description      |
       | ------- | ------ | ---------------- |
       | index   | number | index            |
       | suiteID | string | ID of test suite |
       | testID  | string | ID of test case  |

3. Execute `setup` events,
   
   - On runtime side,
     
     - process `setup` actions of test case.  Test case specific actions are recorded in `actionMap` with a node id of `_global_`.

4. Set timeout,
   
   - On editor side,
     
     - set timeout with timeout value specified for a test case,
     
     - if the timeout is reached or an error is occurred before completion of the test case, a log message is outputted and the test is cleaned up.

5. Completion of the test execution
   
   - The action that validates the test (e.g. match) confirms the result and completes the test when all the checks are performed.
   
   - If number of executed checks reaches reaches number of checks in the test case counted by (1), test is completed and the result is reported.

### Test Configuration

  Configuration of each test suite is stored as `flow-test-config` config node.  It contains following properties:

| name        | type   | description                         |
| ----------- | ------ | ----------------------------------- |
| timeout     | number | timeout value in ms                 |
| max_actions | number | limit on number of executed actions |
| actions     | object | array of action definitions         |

This configuration node is installed together with flow test plugin.  Most part of settings UI of `flow-test-config` config node is generated by event handler of flow testing plugin. 

## Flow Test Plugin Support in Node-RED Editor

Current flow tester implementation uses following additional events in this [repository]([GitHub - node-red-hitachi/node-red at flow-test-support](https://github.com/node-red-hitachi/node-red/tree/flow-test-support)) to Node-RED editor:

- `nodes:dialog-prepare` - fired when preparing node setting panel with following option object as an argument:
  
  | name    | type   | description                                 |
  | ------- | ------ | ------------------------------------------- |
  | node    | object | target node                                 |
  | tabs    | object | tab element of node settings panel          |
  | content | object | content part element of node settings panel |
  
  This is used for creating additional settings panel tab for flow testing for each node.

- ` nodes:dialog-resize` - fired when node setting panel resized with following option object as an argument:
  
  | name | type   | description                                                       |
  | ---- | ------ | ----------------------------------------------------------------- |
  | node | object | target node                                                       |
  | size | object | object representing new size with `height` and `width` properties |

- ` editor:save` - fired when node configuration is saved with target node as an argument.

## Actions Extension

Flow test actions can be added using plugin feature of Node-RED.  Plugins should be initialized by `RED.plugins.registerPlugin` with option object on editor side and runtime side.

On editor side option object consists of following properties:

| name     | type     | description                                              |
| -------- | -------- | -------------------------------------------------------- |
| type     | string   | constant string: "flow-tester-addon"                     |
| onadd    | function | called on removal of plugin                              |
| onremove | function | called on removal of plugin                              |
| actions  | function | function that returns array of action definition objects |

Action definition object consists of following properties:

| name       | type     | description                                                                                                                                                                                                                                                                                                         |
| ---------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| name       | string   | internal name of action                                                                                                                                                                                                                                                                                             |
| label      | string   | menu label                                                                                                                                                                                                                                                                                                          |
| onAddItem  | function | called when adding this action to editableList with option object as an argument. The option object consists of:<br/>- node: target node,<br/>- container: container element of added item,<br/>- selectRow: first row element of action added item,<br/>- data: initial data                                       |
| onSelect   | function | called when this actionItem is selected with option object as an argument. The option object consists of:<br/>- container: container element of added item,<br/>- selectRow: first row element of action added item                                                                                                 |
| onUnselect | function | called when this actionItem is unselected with option object as an argument. The option object consists of:<br/>- container: container element of added item,<br/>- selectRow: first row element of action added item                                                                                               |
| onSave     | function | called when this actionItem is saved with its container element as an argument.  This function must return an object that represents action information.  It consists of following properties:<br/>- value: value needed to execute action,<br/>- performCheck: `true` if this action performs a check of test case |

On runtime side option object consists of following properties:

| name     | type     | description                                                        |
| -------- | -------- | ------------------------------------------------------------------ |
| type     | string   | constant string: "flow-tester-addon"                               |
| onadd    | function | called on removal of plugin                                        |
| onremove | function | called on removal of plugin                                        |
| actions  | function | function that returns array of action execution definition objects |

Action definition object consists of following properties:

| name    | type     | description                                                                                                                                                                                                                                                                                                                                                            |
| ------- | -------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| name    | string   | internal name of action                                                                                                                                                                                                                                                                                                                                                |
| execute | function | function to execute a test action. It returns Promise and takes an option object that consists of following properties:<br/>- action: action definition object saved by onSave callback function,<br/>- node: target node,<br/>- msg: target message<br/>If this function performs check, the returned Promise resolves when check is successful otherwise it rejects. |
